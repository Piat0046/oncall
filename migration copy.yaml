# ============================================================
# 마이그레이션 설정 파일
# 사용법: data-migrate run migration.yaml
# ============================================================

# ------------------------------------------------------------
# 전역 설정
# ------------------------------------------------------------
auto_order: true           # 외래키 기반 자동 순서 정렬
truncate: false            # 삽입 전 테이블 초기화
create_tables: true        # 테이블 자동 생성
exclude_date_tables: true  # 날짜 suffix 테이블 제외 (예: table_20240101)

# 병렬 처리 설정
parallel: true             # DB 병렬 처리 활성화
max_workers: 3             # 동시 DB 처리 수
max_table_workers: 5       # DB당 동시 테이블 처리 수

# ------------------------------------------------------------
# 정적 데이터베이스 목록
# ------------------------------------------------------------
databases:
  # --------------------------------------------------------
  # 예시 1: 전체 테이블 마이그레이션
  # --------------------------------------------------------
  # - name: laplace
  #   mode: all
  #   exclude:
  #     - large_log_table
  #     - temp_table

  # --------------------------------------------------------
  # 예시 2: 특정 테이블만 마이그레이션
  # --------------------------------------------------------
  # - name: analytics
  #   target_name: analytics_backup  # 다른 이름의 타겟 DB
  #   mode: tables
  #   tables:
  #     - users                      # 테이블명만
  #     - orders
  #     - name: events               # 상세 설정
  #       where: "created_at >= '2024-01-01'"
  #       limit: 10000

  # --------------------------------------------------------
  # 예시 3: 전체 테이블에 조건 적용
  # --------------------------------------------------------
  # - name: archive
  #   mode: all
  #   where: "updated_at >= '2024-01-01'"  # 모든 테이블에 적용
  #   limit: 50000
  #   exclude:
  #     - deleted_records

  # --------------------------------------------------------
  # 예시 4: 날짜 테이블 포함 마이그레이션
  # --------------------------------------------------------
  # - name: logs
  #   mode: all
  #   exclude_date_tables: false  # DB별 설정 오버라이드

# ------------------------------------------------------------
# 동적 데이터베이스 (쿼리 결과로 DB명 생성)
# ------------------------------------------------------------
dynamic_databases:
  # --------------------------------------------------------
  # 예시: user_subscription에서 활성 사용자 조회 후
  # laplacian_{user_id} 데이터베이스들을 마이그레이션
  # --------------------------------------------------------
  - pattern: "laplacian_{user_id}"
    lookup_query:
      database: laplace
      sql: |
        SELECT user_id
        FROM user_subscription
        WHERE plan_end_datetime_id > '2025-12-05 00:00:00'
    mode: all
    exclude:
      - large_log_table

  # --------------------------------------------------------
  # 예시: 타겟 DB명을 다르게 지정
  # --------------------------------------------------------
  # - pattern: "tenant_{tenant_id}"
  #   target_pattern: "backup_tenant_{tenant_id}"
  #   lookup_query:
  #     database: master
  #     sql: |
  #       SELECT tenant_id FROM tenants WHERE active = 1
  #   mode: all

  # --------------------------------------------------------
  # 예시: 특정 테이블만 마이그레이션
  # --------------------------------------------------------
  # - pattern: "shop_{shop_id}"
  #   lookup_query:
  #     database: main
  #     sql: SELECT shop_id FROM shops WHERE status = 'active'
  #   mode: tables
  #   tables:
  #     - products
  #     - orders
  #     - name: order_items
  #       where: "created_at >= '2024-01-01'"

# ============================================================
# CLI 사용 예시
# ============================================================
#
# 기본 실행 (병렬):
#   data-migrate run migration.yaml
#
# dry-run (설정 확인만):
#   data-migrate run migration.yaml --dry-run
#
# 동시 DB 수 조정:
#   data-migrate run migration.yaml --max-workers 5
#
# 순차 실행 (디버깅용):
#   data-migrate run migration.yaml --no-parallel
#
# 단일 DB 마이그레이션:
#   data-migrate migrate -d laplace --all
#   data-migrate migrate -d laplace --table users --table orders
#   data-migrate migrate -d laplace --all --exclude large_logs
#   data-migrate migrate -d laplace --all --max-table-workers 10
# ============================================================
